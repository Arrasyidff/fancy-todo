<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
</head>
<body>

    <!-- navabar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="display: flex; justify-content: space-between;">
        <a class="navbar-brand" href="#">Fancy Todo</a>
        <button type="button" class="btn btn-danger" id="btn-logout">Logout</button>
      </nav>

    <!-- register -->
    <div id="register-page" style="margin: 50px auto 10px auto; width: 50%; padding: 10px;">
        <form id="register-form">
            <h1>Register</h1>
            <div class="form-group">
              <label for="email-register">Email address</label>
              <input type="email" class="form-control" id="email-register" aria-describedby="emailHelp">
            </div>
            <div class="form-group">
              <label for="password-register">Password</label>
              <input type="password" class="form-control" id="password-register">
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
    </div>

    <!-- login -->
    <div id="login-page" style="margin: 50px auto 10px auto; width: 50%; padding: 10px;">
        <form id="login-form">
            <h1>login</h1>
            <div class="form-group">
              <label for="email">Email address</label>
              <input type="email" class="form-control" id="email" aria-describedby="emailHelp">
              <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" class="form-control" id="password">
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
    </div>

    <!-- main page -->
    <div id="main-page" style="display: flex; justify-content: center; margin-top: 50px;">
        <div style="border: 1px solid black; width: 100%;">
            <table border="1">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>title</th>
                        <th>description</th>
                        <th>status</th>
                        <th>due date</th>
                        <th>action</th>
                    </tr>
                </thead>
                <tbody id="todo-list">
                        <tr>
                        </tr>
                </tbody>
            </table>
        </div>
        <div style="border: 1px solid black; width: 100%;;">
            <div style="margin: 10px auto 10px auto; width: 50%; padding: 10px;">
                <form id="todo-form">
                    <h1>Add Todo</h1>
                    <div class="form-group">
                      <label for="title-input">Title</label>
                      <input type="text" class="form-control" id="title-input">
                    </div>
                    <div class="form-group">
                        <label for="description-input">Description</label>
                        <input type="text" class="form-control" id="description-input">
                    </div>
                    <div class="form-group">
                        <label for="status-input">Status</label>
                        <input type="text" class="form-control" id="status-input">
                    </div>
                    <div class="form-group">
                        <label for="due_date-input">Due Date</label>
                        <input type="text" class="form-control" id="due_date-input">
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>


                  <!-- UPDATE TODO -->
                  <form id="update-form">
                    <h1>Edit Todo</h1>
                    <div class="form-group">
                      <label for="title-update">Title</label>
                      <input type="text" class="form-control" id="title-update">
                    </div>
                    <div class="form-group">
                        <label for="description-update">Description</label>
                        <input type="text" class="form-control" id="description-update">
                    </div>
                    <div class="form-group">
                        <label for="status-update">Status</label>
                        <input type="text" class="form-control" id="status-update">
                    </div>
                    <div class="form-group">
                        <label for="due_date-update">Due Date</label>
                        <input type="text" class="form-control" id="due_date-update">
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        function showLoginPage() {
            $("#register-page").hide()
            $("#login-page").show()
            $("#main-page").hide()
        }
        function showMainPage() {
            $("#register-page").hide()
            $("#login-page").hide()
            $("#main-page").show()
            fetchTodo()
        }
        function login() {
            const email = $("#email").val()
            const password = $("#password").val()

            $.ajax({
                url: "http://localhost:3000/signIn",
                method: "POST",
                data: {
                    email,
                    password
                }
            })
                .done(response => {
                    // console.log(response)
                    localStorage.setItem("access_token", response.access_token)
                    showMainPage()
                })
                .fail(xhr => {
                    console.log(xhr)
                })
                .always(() => {
                    $("#email").val("")
                    $("#password").val("")
                })
        }
        function logout() {
            localStorage.clear()
            showLoginPage()
        }
        function fetchTodo() {
            $.ajax({
                method: "GET",
                url: "http://localhost:3000/todos",
                headers: {
                    access_token: localStorage.getItem("access_token")
                }
            })
                .done(response => {
                    // console.log(response)
                    $("#todo-list").empty()
                    for (let i = 0; i < response.length; i++) {
                        // console.log(response[i])
                        $("#todo-list").append(`<tr><td> ${i+1} </td>
                        <td>${response[i].title}</td>
                        <td>${response[i].description}</td>
                        <td>${response[i].status}</td>
                        <td>${response[i].due_date}</td>
                        <td>
                            <button type="button" class="btn btn-primary" onclick="editTodo(${response[i].id})">Edit</button>
                            <button type="button" class="btn btn-secondary" onclick="deleteTodo(${response[i].id})">Delete</button>
                        </td></tr>`)
                    }
                })
                .fail(xhr => {
                    console.log(xhr)
                })
        }
        function addTodo() {
            const title = $("#title-input").val()
            const description = $("#description-input").val()
            const status = $("#status-input").val()
            const due_date = $("#due_date-input").val()
            $.ajax({
                method: "POST",
                url: "http://localhost:3000/todos",
                headers: {
                    access_token: localStorage.getItem("access_token")
                },
                data: {
                    title,
                    description,
                    status,
                    due_date
                }
            })
                .done(response => {
                    console.log(response)
                    fetchTodo()
                })
                .fail(xhr => {
                    console.log(xhr)
                })
                .always(_=> {
                    $("#todo-form").trigger("reset")
                })
        }
        function deleteTodo(id) {
            // console.log(id)
            $.ajax({
                method: "DELETE",
                url: "http://localhost:3000/todos/" + id,
                headers: {
                    access_token: localStorage.getItem("access_token")
                }
            })
                .done(response => {
                    fetchTodo()
                })
                .fail(xhr => {
                    console.log(xhr)
                })
        }
        function editTodo(id) {
            console.log(id)

            const title = $("#title-upadate").val()
            const description = $("#description-upadate").val()
            const status = $("#status-upadate").val()
            const due_date = $("#due_date-upadate").val()
            $.ajax({
                method: "PUT",
                url: "http://localhost:3000/todos/" + id,
                headers: {
                    access_token: localStorage.getItem("access_token")
                },
                data: {
                    title,
                    description,
                    status,
                    due_date
                }
            })
                .done(response => {
                    console.log(response)
                })
        }

        $("document").ready(() => {
            $("#title-input").attr("value", "testing")
            $("#description-input").attr("value", "cascjasnc;aslkcsna")
            if (localStorage.getItem("access_token")) {
                showMainPage()
            } else {
                showLoginPage()
            }

            $("#login-form").on("submit", (e) => {
                e.preventDefault()
                login()
            })

            $("#btn-logout").on("click", (e) => {
                logout()
            })

            $("#todo-form").on("submit", (e) => {
                e.preventDefault()
                addTodo()
            })

            $("#title-update").on("click", (e) => {
                editTodo
            })
        })
    </script>
</body>
</html>